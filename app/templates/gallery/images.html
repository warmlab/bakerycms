{% extends "base.html"%}
{% block external_css %}
{% endblock %}
{% block main_content_section %}
<div class="ui basic segment">
	<h2 class="ui header">
		<i class="block layout icon"></i>
		<div class="content">图片管理
            <div class="sub header">Manage your images.</div>
        </div>
	</h2>
	<form action="/gallery/image-upload" method="POST" enctype="multipart/form-data">
		<div class="ui input" id="file-selector-div">
			<input type="file" style="display:none;">
		</div>
		<div class="ui two buttons">
			<button id="file-selector" class="ui orange labeled icon button" type="button">
				<i class="file image outline icon"></i>选择文件
			</button>
			<button class="ui positive labeled icon button">
				<i class="upload icon"></i>开始上传
			</button>
		</div>
		<div id="upload-files"></div>
		<div id="upload-files-preview" class="ui small images"></div>
	</form>
    <h4 class="ui horizontal divider header">
      <i class="block layout icon"></i>图册
    </h4>
</div>
<div class="ui basic segment">
    <div class="ui four stackable cards">
        {% for image in images %}
		<div class="card" id="card-{{image.name}}">
            <div class="image">
                <img src="/gallery/media/{{image.name}}.{{image.ext}}">
            </div>
            <div class="content">
                <div class="header">{{image.upload_name}}</div>
                {% if image.title %}
                <div class="meta">{{image.title}}</div>
                {%endif%}
                {% if image.description %}
                <div class="description">{{image.description}}</div>
                {%endif%}
            </div>
            <div class="extra content">
                <div class="ui two buttons">
                    <div class="ui basic negative button" href="/gallery/image/{{image.name}}" data-show="{{image.upload_name}}" data-name="{{image.name}}" data-ext="{{image.ext}}">删除</div>
                <a class="ui basic positive button" href="/gallery/image/{{image.name}}">编辑</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<div class="ui modal" id="remove-modal">
	<div class="header" id="modal-header">删除图片</div>
	<div class="content">
		<p>请确认从系统里删除图片：<strong id="modal-name"></strong></p>
	</div>
	<div class="actions">
		<div class="ui green deny button">不删除</div>
		<div class="ui red approve button">删除</div>
	</div>
</div>
<div class="ui modal" id="error-message">
	<div class="header" id="modal-header">无法删除图片</div>
	<div class="content">
		<p>无法删除图片该图片，该图片正在被其他元素使用</p>
	</div>
	<div class="actions">
		<div class="ui approve button">好</div>
	</div>
</div>
{% endblock %}
{% block special_script_section %}
{% endblock %}
{% block inline_script_section %}
<script>
$('#file-selector').click(function(e) {
	$('div.input input:file').click();
});

function change_event(e) {
	var name = e.target.files[0].name;
	var file = e.target.files[0];
	$(this).attr('name', 'upload-image');
	$(this).appendTo("#upload-files");
	$('#file-selector-div').html('<input type="file" style="display:none;">');
	$('div.input input:file').change(change_event);
	var path = URL.createObjectURL(file);
	var img_html = '<img class="ui image" src="' + path + '">';
	$("#upload-files-preview").append(img_html);
}

$('div.input input:file').change(change_event);

$('div.negative.button').click(function(e){
	$('#modal-header').html('删除图片-' + $(this).data('show'));
	$('#modal-name').html($(this).data('name'));
	$("#remove-modal")
		.modal('setting', 'closable', false)
		.modal({
			closable: false,
			allowMultiple: true,
			onApprove: function(){
                //$.post('{{url_for(".image_delete")}}', {name: '"' + $('#modal-name').html() + '"'}, dataType='json')
                $.post('{{url_for(".image_delete")}}', {name: $('#modal-name').html()})
                    .done(function(result){
                        if (result.errcode == 0)
                            $('div[id="card-' + $('#modal-name').html() + '"]').remove();
                    })
                    .fail(function(result){
						$('#error-message').modal('show');
                    });
			}
		})
		.modal('show');
});
</script>
{% endblock %}
