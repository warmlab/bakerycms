{% extends "base-user.html" %}
{% block main_content_section %}
<div class="ui basic segment">
    <img id="banner-image" class="ui big image" src="/gallery/media/{{product.images[0].image.name}}.{{product.images[0].image.ext}}"><p/>
    <div class="ui tiny images">
        {% for pi in product.images %}
        <img src="/gallery/media/{{pi.image.name}}.{{pi.image.ext}}">
        {% endfor %}
    </div>
    <h3 class="ui header">
        <div class="content">
			{{product.name}}
          <div class="sub header" id="product-price">
              ￥{{product.price}}
          </div>
        </div>
    </h3>
	<p>{{product.description}}</p>{#
    <div class="ui labeled mini input">
        <div class="ui label">购买数量</div>
        <input id="amount" value="1" maxlength="5" size="6" placeholder="1" type="text">
    </div>
    <div class="ui mini buttons">
        <button class="ui icon button" type="button">
            <i class="minus icon"></i>
        </button>
        <button class="ui icon orange button" type="button">
            <i class="plus icon"></i>
        </button>
    </div>#}
	{% if parameter_categories %}
	{% for key,values in parameter_categories.items() %}
	<h4 class="ui sub header">
		<div class="content">
			选择{{key}}
		</div>
	</h4>
	<span>
	{% for value in values %}
	<div class="ui basic toggle button" data-code="{{value.parameter_id}}" data-price="{{value.plus_price}}">{{value.parameter}}</div>
	{% endfor %}
	</span>
	{% endfor %}
	{% endif %}
	<h4 class="ui sub header"></h4>
	<div class="ui fluid orange right labeled icon huge button">
		<i class="add to cart icon"></i>添加到购物车
	</div>
</div>
{% include "includes/delivery.html" %}
<div style="padding-bottom: 40px;"></div>
{% endblock %}
{% block bottom_nav_section %}
{% include "includes/bottom_fixed.html" %}
{% endblock %}
{% block special_script_section %}
<script src="{{url_for('static', filename='js/shop.js')}}"></script>
{% endblock %}
{% block inline_script_section %}
<script>
$(document).ready(function(){
	$toggle = $('div.toggle.button');
	$active = 'orange';
	handler = {
		activate: function(){
			if ($(this).hasClass($active))
				$(this).removeClass($active).addClass('basic');
			else
				$(this).addClass($active).removeClass('basic')
					.siblings().removeClass($active).addClass('basic');
			var price = {{product.price}};
			$toggle.each(function() {
				if ($(this).hasClass($active)) {
					price += parseFloat($(this).data('price'));
				}
			});
			$('#product-price').html('￥' + price);
		}
	};
	$toggle.click(handler.activate);
	//$toggle.click(function(){
	//	$('div.toggle.button[name="' + $(this).attr('name') + '"]').removeClass($active).addClass('basic');
	//	$(this).state('active');
	//	//$(this).removeClass('basic').addClass($active);
	//});
$(".ui.tiny.images img").click(function(){
    var src = $(this).attr('src');
    if ($("#banner-image").attr('src') != src) {
        $("#banner-image").fadeOut('fast', function(){
            $("#banner-image").attr('src', src);
        });
        $("#banner-image").fadeIn('fast');
    }
});

$('.ui.fluid.button').click(function(e){
	// add product to cart
	//var code = "{{product.code}}";
	//var parameters = [];
	//$toggle.each(function() {
	//	if ($(this).hasClass($active)) {
	//		parameters.push($(this).data('code'));
	//	}
	//});
	//console.log(parameters);
	//$.post('/shop/add-to-cart', {code: parameters})
	//	.done(function(){
	//		console.log('added');
	//	})
	//	.fail(function(){
	//		console.log('failed');
	//	});

	//$('.ui.popup').popup('show');
	var obj = $("#banner-image").clone();
	obj.removeAttr('id');
	obj.removeClass('big').addClass('tiny');
	obj.insertAfter($(this)).fadeTo(10, 0.9);

	obj.css({
		position: 'absolute',
		left: e.pageX,
		top: e.pageY,
		zIndex: 1
	}).animate({
		top: $('#cart').offset().top,
		left: $('#cart').offset().left + $('#cart').width() / 2
	}, 1000, function(){
		obj.remove();
		// add product to cart
		var code = "{{product.code}}";
		var name = "{{product.name}}";
		var image = "/gallery/media/{{product.images[0].image.name}}.{{product.images[0].image.ext}}";
		var price = "{{product.price}}";
		var p = new Product(code, name, image, price, 1);
		$toggle.each(function() {
			if ($(this).hasClass($active)) {
				var code = $(this).data('code');
				var price = $(this).data('price');
				p.parameters[code] = price;
				console.log(p.parameters.keys());
			}
		});

		var cart = new Cart('cart', 'session');
		cart.addProduct(p);
	});

	//obj.offset({top: e.pageX, left: e.pageY, zIndex: 10});
});
});
</script>
{% endblock %}
